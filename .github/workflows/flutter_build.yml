  name: Flutter Build & Deploy with Auto Tag

  on:
    push:
      branches: [ "main", "master" ]
      tags: [ "v*" ]
    pull_request:
      branches: [ "main", "master" ]
      types: [ "closed" ]
    workflow_dispatch:

  jobs:
    # -----------------------------------------------------------------------------
    # AUTO TAGGING
    # -----------------------------------------------------------------------------
    auto-tag:
      runs-on: ubuntu-latest
      if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
      permissions:
        contents: write
      outputs:
        new_version: ${{ steps.calculate_version.outputs.new_version }}
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
            token: ${{ secrets.GITHUB_TOKEN }}

        - name: Get latest tag
          id: get_latest_tag
          run: |
            # Fetch all tags first
            git fetch --tags
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

        - name: Calculate new version
          id: calculate_version
          run: |
            LATEST_TAG="${{ steps.get_latest_tag.outputs.latest_tag }}"
            VERSION=${LATEST_TAG#v}
            
            IFS='.' read -r -a PARTS <<< "$VERSION"
            MAJOR=${PARTS[0]:-0}
            MINOR=${PARTS[1]:-0}
            PATCH=${PARTS[2]:-0}
            
            # Find next available version using existing tags
            # Since we already fetched all tags with git fetch --tags, 
            # git rev-parse will check both local and remote
            MAX_ATTEMPTS=50
            ATTEMPT=0
            
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              PATCH=$((PATCH + 1))
              NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
              ATTEMPT=$((ATTEMPT + 1))
              
              # Check if tag exists (local or remote)
              if ! git rev-parse "$NEW_VERSION" >/dev/null 2>&1; then
                break
              fi
            done
            
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "Error: Could not find available version after $MAX_ATTEMPTS attempts"
              exit 1
            fi
            
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "New version: $NEW_VERSION"

        - name: Update pubspec.yaml version
          run: |
            NEW_VERSION="${{ steps.calculate_version.outputs.new_version }}"
            # Remove 'v' prefix for pubspec version
            VERSION_NUM=${NEW_VERSION#v}
            # Update pubspec.yaml version
            sed -i "s/^version: .*/version: $VERSION_NUM+${VERSION_NUM//./}/" pubspec.yaml
            echo "Updated pubspec.yaml to version: $VERSION_NUM+${VERSION_NUM//./}"
            
        - name: Create and push tag
          run: |
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            NEW_VERSION="${{ steps.calculate_version.outputs.new_version }}"
            
            # Commit version update
            git add pubspec.yaml
            if git diff-index --quiet HEAD --; then
              echo "No changes to commit"
            else
              git commit -m "chore: update version to $NEW_VERSION"
            fi
            
            # Create tag
            git tag -a "$NEW_VERSION" -m "Auto-generated tag: $NEW_VERSION"
            
            # Push everything in one command to reduce network calls
            git push origin main "$NEW_VERSION"
            echo "Created tag: $NEW_VERSION"

    # -----------------------------------------------------------------------------
    # -----------------------------------------------------------------------------
    # ANDROID
    # -----------------------------------------------------------------------------
    build-android:
      runs-on: ubuntu-latest
      needs: auto-tag
      if: needs.auto-tag.result == 'success' || startsWith(github.ref, 'refs/tags/v')
      steps:
        - uses: actions/checkout@v4
        
        - uses: actions/setup-java@v4
          with:
            distribution: 'temurin'
            java-version: '17'
            
        - name: Cache Gradle packages
          uses: actions/cache@v4
          with:
            path: |
              ~/.gradle/caches
              ~/.gradle/wrapper
            key: ${{ runner.os }}-gradle-${{ hashFiles('**/android/*.gradle*', '**/android/app/*.gradle*', '**/android/gradle/wrapper/gradle-wrapper.properties') }}
            restore-keys: |
              ${{ runner.os }}-gradle-
            
        - uses: subosito/flutter-action@v2
          with:
            channel: 'stable'
            cache: true
            
        - name: Configure Gradle for network reliability
          run: |
            mkdir -p ~/.gradle
            echo "org.gradle.parallel=true" >> ~/.gradle/gradle.properties
            echo "org.gradle.caching=true" >> ~/.gradle/gradle.properties
            echo "org.gradle.configureondemand=true" >> ~/.gradle/gradle.properties
            echo "systemProp.http.keepAlive=true" >> ~/.gradle/gradle.properties
            echo "systemProp.http.maxConnections=50" >> ~/.gradle/gradle.properties
            echo "systemProp.org.gradle.internal.http.connectionTimeout=120000" >> ~/.gradle/gradle.properties
            echo "systemProp.org.gradle.internal.http.socketTimeout=120000" >> ~/.gradle/gradle.properties
            
        - name: Add additional Maven repositories
          run: |
            # Add fallback repositories to settings.gradle.kts
            sed -i '/gradlePluginPortal()/a\        maven { url = uri("https://jitpack.io") }\n        maven { url = uri("https://dl.google.com/dl/android/maven2") }' android/settings.gradle.kts
            
        - name: Create local.properties
          run: |
            echo "flutter.sdk=$FLUTTER_ROOT" > android/local.properties
            echo "sdk.dir=$ANDROID_HOME" >> android/local.properties
            echo "Created local.properties with flutter.sdk=$FLUTTER_ROOT"
            cat android/local.properties

        - name: Download Flutter Android artifacts
          run: flutter precache --android
          
        - name: Verify Flutter artifacts
          run: |
            echo "Flutter SDK: $FLUTTER_ROOT"
            ls -la "$FLUTTER_ROOT/bin/cache/artifacts/engine/" || echo "No engine directory"
            ls -la "$FLUTTER_ROOT/bin/cache/artifacts/engine/android-arm64-release/" 2>/dev/null || echo "No android-arm64-release directory"
            find "$FLUTTER_ROOT/bin/cache" -name "flutter.jar" 2>/dev/null | head -5 || echo "No flutter.jar found"
          
        - name: Get Dependencies
          run: flutter pub get
          
        - name: Build Android APK
          run: flutter build apk --release
          env:
            GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true"
          
        - name: Upload APK
          uses: actions/upload-artifact@v4
          with:
            name: app-release-apk
            path: build/app/outputs/flutter-apk/app-release.apk

    # -----------------------------------------------------------------------------
    # WINDOWS
    # -----------------------------------------------------------------------------
    build-windows:
      runs-on: windows-latest
      needs: auto-tag
      if: needs.auto-tag.result == 'success' || startsWith(github.ref, 'refs/tags/v')
      steps:
        - uses: actions/checkout@v4
        
        - uses: subosito/flutter-action@v2
          with:
            channel: 'stable'
            cache: true
            
        - name: Enable Windows Desktop
          run: flutter config --enable-windows-desktop
          
        - name: Get Dependencies
          run: flutter pub get
          
        - name: Build Windows
          run: flutter build windows --release
          
        - name: Upload Windows Build
          uses: actions/upload-artifact@v4
          with:
            name: windows-build
            path: build/windows/x64/runner/Release/

    # -----------------------------------------------------------------------------
    # LINUX
    # -----------------------------------------------------------------------------
    build-linux:
      runs-on: ubuntu-latest
      needs: auto-tag
      if: needs.auto-tag.result == 'success' || startsWith(github.ref, 'refs/tags/v')
      steps:
        - uses: actions/checkout@v4
        
        - name: Install Linux Dependencies
          run: |
            sudo apt-get update
            sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
            
        - uses: subosito/flutter-action@v2
          with:
            channel: 'stable'
            cache: true
            
        - name: Enable Linux Desktop
          run: flutter config --enable-linux-desktop
          
        - name: Get Dependencies
          run: flutter pub get
          
        - name: Build Linux
          run: flutter build linux --release
          
        - name: Upload Linux Build
          uses: actions/upload-artifact@v4
          with:
            name: linux-build
            path: build/linux/x64/release/bundle/

    # -----------------------------------------------------------------------------
    # MACOS
    # -----------------------------------------------------------------------------
    build-macos:
      runs-on: macos-latest
      needs: auto-tag
      if: needs.auto-tag.result == 'success' || startsWith(github.ref, 'refs/tags/v')
      steps:
        - uses: actions/checkout@v4
        
        - uses: subosito/flutter-action@v2
          with:
            channel: 'stable'
            cache: true
            
        - name: Enable macOS Desktop
          run: flutter config --enable-macos-desktop
          
        - name: Get Dependencies
          run: flutter pub get
          
        - name: Build macOS
          # Note: This produces an unsigned .app bundle.
          run: flutter build macos --release
          
        - name: Upload macOS Build
          uses: actions/upload-artifact@v4
          with:
            name: macos-build
            path: build/macos/Build/Products/Release/*.app

    # -----------------------------------------------------------------------------
    # WEB & DEPLOY PAGE
    # -----------------------------------------------------------------------------
    build-web:
      runs-on: ubuntu-latest
      needs: auto-tag
      if: needs.auto-tag.result == 'success' || startsWith(github.ref, 'refs/tags/v')
      permissions:
        contents: write
      steps:
        - uses: actions/checkout@v4
        
        - uses: subosito/flutter-action@v2
          with:
            channel: 'stable'
            cache: true
            
        - name: Get Dependencies
          run: flutter pub get
          
        - name: Build Web
  
          run: flutter build web --release --base-href "/service app/"
          
        - name: Upload Web Build
          uses: actions/upload-artifact@v4
          with:
            name: web-build
            path: build/web
            
        - name: Deploy to GitHub Pages
          # Deploy only on push to main (so the site is always live)
          if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
          uses: peaceiris/actions-gh-pages@v3
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            publish_dir: ./build/web

    # -----------------------------------------------------------------------------
    # CREATE GITHUB RELEASE
    # -----------------------------------------------------------------------------
    release:
      runs-on: ubuntu-latest
      needs: [auto-tag, build-android, build-windows, build-linux, build-macos, build-web]
      if: needs.auto-tag.result == 'success' || startsWith(github.ref, 'refs/tags/v')
      permissions:
        contents: write
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            ref: ${{ needs.auto-tag.outputs.new_version || github.ref_name }}

        - name: Download Artifacts
          uses: actions/download-artifact@v4
          with:
            path: artifacts

        - name: Archive Builds
          run: |
            # Zip Windows
            if [ -d "artifacts/windows-build" ]; then
              cd artifacts/windows-build
              zip -r ../../app-release-windows.zip .
              cd ../..
            fi
            
            # Zip Linux
            if [ -d "artifacts/linux-build" ]; then
              cd artifacts/linux-build
              zip -r ../../app-release-linux.zip .
              cd ../..
            fi
            
            # Zip macOS
            if [ -d "artifacts/macos-build" ]; then
              cd artifacts/macos-build
              zip -r ../../app-release-macos.zip .
              cd ../..
            fi
            
            # Zip Web
            if [ -d "artifacts/web-build" ]; then
              cd artifacts/web-build
              zip -r ../../app-release-web-offline.zip .
              cd ../..
            fi
            
            # Copy APK
            if [ -d "artifacts/app-release-apk" ]; then
              cp artifacts/app-release-apk/app-release.apk ./app-release-android.apk
            fi

        - name: Create GitHub Release
          uses: softprops/action-gh-release@v1
          with:
            tag_name: ${{ needs.auto-tag.outputs.new_version || github.ref_name }}
            files: |
              app-release-android.apk
              app-release-windows.zip
              app-release-linux.zip
              app-release-macos.zip
              app-release-web-offline.zip
            draft: false
            prerelease: false

