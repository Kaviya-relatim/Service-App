  name: Flutter Build & Deploy with Auto Tag

  on:
    push:
      branches: [ "main", "master" ]
      tags: [ "v*" ]
    pull_request:
      branches: [ "main", "master" ]
      types: [ "closed" ]
    workflow_dispatch:

  jobs:
    # -----------------------------------------------------------------------------
    # AUTO TAGGING
    # -----------------------------------------------------------------------------
    auto-tag:
      runs-on: ubuntu-latest
      if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
      permissions:
        contents: write
      outputs:
        new_version: ${{ steps.calculate_version.outputs.new_version }}
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
            token: ${{ secrets.GITHUB_TOKEN }}

        - name: Get latest tag
          id: get_latest_tag
          run: |
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

        - name: Calculate new version
          id: calculate_version
          run: |
            LATEST_TAG="${{ steps.get_latest_tag.outputs.latest_tag }}"
            VERSION=${LATEST_TAG#v}
            
            IFS='.' read -r -a PARTS <<< "$VERSION"
            MAJOR=${PARTS[0]:-0}
            MINOR=${PARTS[1]:-0}
            PATCH=${PARTS[2]:-0}
            
            # Find next available version
            while true; do
              PATCH=$((PATCH + 1))
              NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
              
              # Check if tag exists locally
              if ! git rev-parse "$NEW_VERSION" >/dev/null 2>&1; then
                break
              fi
            done
            
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "New version: $NEW_VERSION"

        - name: Create and push tag
          run: |
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            NEW_VERSION="${{ steps.calculate_version.outputs.new_version }}"
            
            git tag -a "$NEW_VERSION" -m "Auto-generated tag: $NEW_VERSION"
            git push origin "$NEW_VERSION"
            echo "Created tag: $NEW_VERSION"

    # -----------------------------------------------------------------------------
    # -----------------------------------------------------------------------------
    # ANDROID
    # -----------------------------------------------------------------------------
    build-android:
      runs-on: ubuntu-latest
      needs: auto-tag
      if: needs.auto-tag.result == 'success' || startsWith(github.ref, 'refs/tags/v')
      steps:
        - uses: actions/checkout@v4
        
        - uses: actions/setup-java@v4
          with:
            distribution: 'temurin'
            java-version: '17'
            
        - name: Cache Gradle packages
          uses: actions/cache@v4
          with:
            path: |
              ~/.gradle/caches
              ~/.gradle/wrapper
            key: ${{ runner.os }}-gradle-${{ hashFiles('**/android/*.gradle*', '**/android/app/*.gradle*', '**/android/gradle/wrapper/gradle-wrapper.properties') }}
            restore-keys: |
              ${{ runner.os }}-gradle-
            
        - uses: subosito/flutter-action@v2
          with:
            channel: 'stable'
            flutter-version: '3.27.2'
            cache: true

        - name: Create local.properties
          run: |
            SDK_DIR="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
            if [ -z "$SDK_DIR" ]; then
              echo "Android SDK path not found. Set ANDROID_SDK_ROOT or ANDROID_HOME."
              exit 1
            fi

            if [ -z "$FLUTTER_ROOT" ]; then
              echo "FLUTTER_ROOT is not set; flutter-action should define it."
              exit 1
            fi

            mkdir -p android
            echo "flutter.sdk=$FLUTTER_ROOT" > android/local.properties
            echo "sdk.dir=$SDK_DIR" >> android/local.properties
            
        - name: Clean Android build
          run: |
            cd android
            if [ -f "./gradlew" ]; then
              chmod +x ./gradlew
              ./gradlew clean
            else
              echo "gradlew not found, skipping clean"
            fi
            cd ..
            
        - name: Ensure Gradle wrapper exists
          run: |
            cd android
            if [ ! -f "./gradlew" ]; then
              echo "Downloading Gradle wrapper..."
              gradle wrapper --gradle-version 8.7
            fi
            chmod +x ./gradlew
            cd ..
            
        - name: Accept Android SDK licenses
          run: flutter doctor --android-licenses -y
          
        - name: Verify Flutter setup
          run: flutter doctor
          
        - name: Setup Android SDK
          run: |
            echo "y" | $ANDROID_HOME/tools/bin/sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
            
        - name: Check Android Environment
          run: |
            echo "ANDROID_HOME: $ANDROID_HOME"
            echo "Java version:"
            java -version
            echo "Flutter version:"
            flutter --version
            echo "Flutter doctor:"
            flutter doctor -v
            
        - name: Configure Gradle for network reliability
          run: |
            mkdir -p ~/.gradle
            echo "org.gradle.parallel=true" >> ~/.gradle/gradle.properties
            echo "org.gradle.caching=true" >> ~/.gradle/gradle.properties
            echo "org.gradle.configureondemand=true" >> ~/.gradle/gradle.properties
            echo "systemProp.http.keepAlive=true" >> ~/.gradle/gradle.properties
            echo "systemProp.http.maxConnections=50" >> ~/.gradle/gradle.properties
            echo "systemProp.org.gradle.internal.http.connectionTimeout=120000" >> ~/.gradle/gradle.properties
            echo "systemProp.org.gradle.internal.http.socketTimeout=120000" >> ~/.gradle/gradle.properties
            
        - name: Add additional Maven repositories
          run: |
            # Add fallback repositories to settings.gradle.kts
            sed -i '/gradlePluginPortal()/a\        maven { url = uri("https://jitpack.io") }\n        maven { url = uri("https://dl.google.com/dl/android/maven2") }' android/settings.gradle.kts
            
        - name: Get Dependencies
          run: flutter pub get
          
        - name: Upgrade Dependencies
          run: flutter pub upgrade --major-versions
          
        - name: Flutter Clean
          run: flutter clean
          
        - name: Test Gradle Build
          run: |
            cd android
            chmod +x ./gradlew
            ./gradlew app:dependencies --configuration releaseRuntimeClasspath
            cd ..
            
        - name: Build Debug APK first
          run: flutter build apk --debug --android-skip-build-dependency-validation
          continue-on-error: true
          
        - name: Check Android Manifest
          run: |
            cat android/app/src/main/AndroidManifest.xml || echo "AndroidManifest.xml not found"
            
        - name: Run Gradle Build with Debug Output
          run: |
            cd android
            if [ -f "./gradlew" ]; then
              ./gradlew app:assembleRelease --debug --stacktrace
            else
              echo "gradlew not found, skipping Gradle build"
            fi
            cd ..
            
        - name: Build Android APK
          run: flutter build apk --release --android-skip-build-dependency-validation --no-tree-shake-icons
          env:
            GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true"
          
        - name: Build Android APK
          run: flutter build apk --release --android-skip-build-dependency-validation --no-tree-shake-icons
          env:
            GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true"
          continue-on-error: false
          
        - name: Verify APK exists
          run: |
            if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
              echo "APK built successfully!"
              ls -la build/app/outputs/flutter-apk/
            else
              echo "APK not found. Checking for build outputs..."
              find build/app/outputs -type f -name "*.apk" || echo "No APK files found"
              exit 1
            fi
          
        - name: Upload APK
          uses: actions/upload-artifact@v4
          with:
            name: app-release-apk
            path: build/app/outputs/flutter-apk/app-release.apk

    # -----------------------------------------------------------------------------
    # WINDOWS
    # -----------------------------------------------------------------------------
    build-windows:
      runs-on: windows-latest
      needs: auto-tag
      if: needs.auto-tag.result == 'success' || startsWith(github.ref, 'refs/tags/v')
      steps:
        - uses: actions/checkout@v4
        
        - uses: subosito/flutter-action@v2
          with:
            channel: 'stable'
            cache: true
            
        - name: Enable Windows Desktop
          run: flutter config --enable-windows-desktop
          
        - name: Get Dependencies
          run: flutter pub get
          
        - name: Build Windows
          run: flutter build windows --release
          
        - name: Upload Windows Build
          uses: actions/upload-artifact@v4
          with:
            name: windows-build
            path: build/windows/x64/runner/Release/

    # -----------------------------------------------------------------------------
    # LINUX
    # -----------------------------------------------------------------------------
    build-linux:
      runs-on: ubuntu-latest
      needs: auto-tag
      if: needs.auto-tag.result == 'success' || startsWith(github.ref, 'refs/tags/v')
      steps:
        - uses: actions/checkout@v4
        
        - name: Install Linux Dependencies
          run: |
            sudo apt-get update
            sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
            
        - uses: subosito/flutter-action@v2
          with:
            channel: 'stable'
            cache: true
            
        - name: Enable Linux Desktop
          run: flutter config --enable-linux-desktop
          
        - name: Get Dependencies
          run: flutter pub get
          
        - name: Build Linux
          run: flutter build linux --release
          
        - name: Upload Linux Build
          uses: actions/upload-artifact@v4
          with:
            name: linux-build
            path: build/linux/x64/release/bundle/

    # -----------------------------------------------------------------------------
    # MACOS
    # -----------------------------------------------------------------------------
    build-macos:
      runs-on: macos-latest
      needs: auto-tag
      if: needs.auto-tag.result == 'success' || startsWith(github.ref, 'refs/tags/v')
      steps:
        - uses: actions/checkout@v4
        
        - uses: subosito/flutter-action@v2
          with:
            channel: 'stable'
            cache: true
            
        - name: Enable macOS Desktop
          run: flutter config --enable-macos-desktop
          
        - name: Get Dependencies
          run: flutter pub get
          
        - name: Build macOS
          # Note: This produces an unsigned .app bundle.
          run: flutter build macos --release
          
        - name: Upload macOS Build
          uses: actions/upload-artifact@v4
          with:
            name: macos-build
            path: build/macos/Build/Products/Release/*.app

    # -----------------------------------------------------------------------------
    # WEB & DEPLOY PAGE
    # -----------------------------------------------------------------------------
    build-web:
      runs-on: ubuntu-latest
      needs: auto-tag
      if: needs.auto-tag.result == 'success' || startsWith(github.ref, 'refs/tags/v')
      permissions:
        contents: write
      steps:
        - uses: actions/checkout@v4
        
        - uses: subosito/flutter-action@v2
          with:
            channel: 'stable'
            cache: true
            
        - name: Get Dependencies
          run: flutter pub get
          
        - name: Build Web
         
          run: flutter build web --release --base-href "/Service-App/"
          
        - name: Upload Web Build
          uses: actions/upload-artifact@v4
          with:
            name: web-build
            path: build/web
            
        - name: Deploy to GitHub Pages
          # Deploy only on push to main (so the site is always live)
          if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
          uses: peaceiris/actions-gh-pages@v3
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            publish_dir: ./build/web

    # -----------------------------------------------------------------------------
    # CREATE GITHUB RELEASE
    # -----------------------------------------------------------------------------
    release:
      runs-on: ubuntu-latest
      needs: [auto-tag, build-android, build-windows, build-linux, build-macos, build-web]
      if: needs.auto-tag.result == 'success' || startsWith(github.ref, 'refs/tags/v')
      permissions:
        contents: write
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            ref: ${{ needs.auto-tag.outputs.new_version || github.ref_name }}

        - name: Download Artifacts
          uses: actions/download-artifact@v4
          with:
            path: artifacts

        - name: Archive Builds
          run: |
            # Zip Windows
            if [ -d "artifacts/windows-build" ]; then
              cd artifacts/windows-build
              zip -r ../../app-release-windows.zip .
              cd ../..
            fi
            
            # Zip Linux
            if [ -d "artifacts/linux-build" ]; then
              cd artifacts/linux-build
              zip -r ../../app-release-linux.zip .
              cd ../..
            fi
            
            # Zip macOS
            if [ -d "artifacts/macos-build" ]; then
              cd artifacts/macos-build
              zip -r ../../app-release-macos.zip .
              cd ../..
            fi
            
            # Zip Web
            if [ -d "artifacts/web-build" ]; then
              cd artifacts/web-build
              zip -r ../../app-release-web-offline.zip .
              cd ../..
            fi
            
            # Copy APK
            if [ -d "artifacts/app-release-apk" ]; then
              cp artifacts/app-release-apk/app-release.apk ./app-release-android.apk
            fi

        - name: Create GitHub Release
          uses: softprops/action-gh-release@v1
          with:
            tag_name: ${{ needs.auto-tag.outputs.new_version || github.ref_name }}
            files: |
              app-release-android.apk
              app-release-windows.zip
              app-release-linux.zip
              app-release-macos.zip
              app-release-web-offline.zip
            draft: false
            prerelease: false

